<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah DO Baru</title>
    
    <!-- CSS SCRIPT -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="css/style.css" rel="stylesheet">

    <!-- Vue.js SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="dataBahanAjar.js"></script>
</head>
<body>
    <!-- NAVBAR -->    
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="https://upload.wikimedia.org/wikipedia/id/c/c3/Logo_Universitas_Terbuka.svg" alt="Logo UT" class="me-2 img-fluid" style="height: 24px;">
                Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="stok.html">Informasi Bahan Ajar</a></li>
                    <li class="nav-item"><a class="nav-link text-primary" href="tracking.html">Tracking Pengiriman</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Laporan
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Monitoring Progress DO Bahan Ajar</a></li>
                            <li><a class="dropdown-item" href="#">Rekap Bahan Ajar</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="#">Histori Transaksi Bahan Ajar</a></li>
                </ul>
                <a href="logout.html"><button class="btn btn-primary ms-3">Keluar</button></a>
            </div>
        </div>
    </nav>
    <!-- SELESAI NAVBAR -->

    <div id="app" class="container pt-5">    
    <div class="card">
        <h2 class="text-center">Tambah Delivery Order Baru</h2>
        <div class="form-group">
            <label>Nomor DO Otomatis:</label>
            <div class="do-number">{{ newDO.nomorDO }}</div>
        </div>
        
        <form @submit.prevent="tambahDOBaru">
            <div class="form-group">
                <label for="nim">NIM Mahasiswa:</label>
                <input type="text" id="nim" v-model="newDO.nim" required maxlength="9">
            </div>
            
            <div class="form-group">
                <label for="nama">Nama Mahasiswa:</label>
                <input type="text" id="nama" v-model="newDO.nama" required>
            </div>

            <div class="form-group">
                <label for="ekspedisi">Ekspedisi:</label>
                <select id="ekspedisi" v-model="newDO.ekspedisi" required>
                    <option disabled value="">Pilih Ekspedisi</option>
                    <option 
                        v-for="item in pengirimanList" 
                        :value="'JNE ' + item.kode" 
                        :key="item.kode"
                    >
                        JNE {{ item.nama }}
                    </option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="tanggalKirim">Tanggal Kirim:</label>
                <input type="date" id="tanggalKirim" v-model="newDO.tanggalKirim" required>
            </div>

            <div class="form-group">
                <label for="paket">Paket Dipilih:</label>
                <select id="paket" v-model="newDO.paket" required>
                    <option disabled value="">Pilih salah satu paket</option>
                    <option v-for="p in paket" :value="p.kode" :key="p.kode">
                        {{ p.nama }} ({{ p.kode }}) - Rp{{ p.harga.toLocaleString('id-ID') }}
                    </option>
                </select>

                <div class="paket-detail" v-if="selectedPackage">
                    <p><strong>Nama Paket:</strong> {{ selectedPackage.nama }}</p>
                    <p><strong>Kode MK:</strong> {{ selectedPackage.isi.join(', ') }}</p>
                    <p><strong>Harga:</strong> Rp{{ selectedPackage.harga.toLocaleString('id-ID') }}</p>
                </div>
                </div>

            <div class="form-group">
                <label>Total Harga (Konfirmasi):</label>
                <div class="do-number" v-if="selectedPackage">
                    Rp{{ selectedPackage.harga.toLocaleString('id-ID') }}
                </div>
                <div class="do-number" v-else style="background-color: #ffcccc;">
                    Rp0
                </div>
            </div>

            <button type="submit" class="btn">Simpan DO Baru</button>
        </form>
    </div>

    <div class="card">
        <h2>Daftar Delivery Order ({{ Object.keys(tracking).length }})</h2>
        <ul v-if="Object.keys(tracking).length > 0">
            <li v-for="(item, doNum) in tracking" :key="doNum">
                <b>{{ doNum }}</b> | {{ item.nama }} (NIM: {{ item.nim }}) | Paket: {{ item.paket }} - Total: Rp{{ item.total.toLocaleString('id-ID') }}
                <br>
                <small>Ekspedisi: {{ item.ekspedisi }} | Dikirim: {{ item.tanggalKirim }}</small> (Status: {{ item.status }}) 
            </li>
        </ul>
        <p v-else>Belum ada data Tracking DO.</p>
    </div>

</div>
<!-- BOOTSTRAP SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const existingData = app.$data;
function getTodayDateString() {
    return new Date().toISOString().slice(0, 10);
}

// --- PENOMORAN OTOMATIS DO ---
function getNextSequenceNumber(trackingData) {
    const currentYear = new Date().getFullYear();
    // Prefix untuk mencocokkan key yang ada di dataBahanAjar.js, yaitu "DO2025-"
    const prefix = `DO${currentYear}-`; 
    let maxSequence = 0;
    
    for (const doNum in trackingData) {
        if (doNum.startsWith(prefix) || doNum.startsWith(`DO-${currentYear}-`)) {
            // Logika untuk mencocokkan format DOYYYY-NNN atau DO-YYYY-NNN
            const sequenceStr = doNum.slice(-4); // Menggunakan 4 digit padding (0001)
            const sequenceNum = parseInt(sequenceStr);
            if (!isNaN(sequenceNum) && sequenceNum > maxSequence) {
                maxSequence = sequenceNum;
            }
        }
    }
    return maxSequence + 1;
}

function generateNewDONumber(trackingData) {
    const currentYear = new Date().getFullYear();
    const nextSequence = getNextSequenceNumber(trackingData);
    const sequencePadded = String(nextSequence).padStart(4, '0'); // Menggunakan 4 digit padding (0001)
    
    // Format DOYYYY-NNNN
    return `DO${currentYear}-${sequencePadded}`; 
}

// --- VUE.JS ---
var appNew = new Vue({
  el: '#app',
  data: {
      ...existingData, 
      newDO: {
          nomorDO: '', 
          nim: '',
          nama: '',
          paket: '',
          ekspedisi: '', 
          tanggalKirim: getTodayDateString(), 
          status: 'Menunggu Dikirim',
      }
  },
  mounted() {
      this.resetNewDOForm();
  },
  computed: {
      selectedPackage() {
          // Cari paket yang dipilih berdasarkan kode
          return this.paket.find(p => p.kode === this.newDO.paket);
      }
  },
  methods: {
      resetNewDOForm() {
          this.newDO.nomorDO = generateNewDONumber(this.tracking);
          this.newDO.nim = '';
          this.newDO.nama = '';
          this.newDO.paket = '';
          this.newDO.ekspedisi = '';
          this.newDO.tanggalKirim = getTodayDateString(); 
          this.newDO.status = 'Menunggu Dikirim';
      },
      
      tambahDOBaru() {
          if (!this.selectedPackage) {
              alert("Pilih paket yang valid!");
              return;
          }

          const nomorDO = this.newDO.nomorDO;
          const totalHarga = this.selectedPackage.harga; 
          const tanggalKirimDO = this.newDO.tanggalKirim; 
          const currentTime = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

          const newTrackingEntry = {
              nim: this.newDO.nim,
              nama: this.newDO.nama,
              status: this.newDO.status,
              ekspedisi: this.newDO.ekspedisi,
              tanggalKirim: tanggalKirimDO, 
              paket: this.newDO.paket,
              total: totalHarga, 
              perjalanan: [
                  { 
                      waktu: `${tanggalKirimDO} ${currentTime}`, 
                      keterangan: `DO Dibuat dengan status: ${this.newDO.status}` 
                  }
              ]
          };

          this.$set(this.tracking, nomorDO, newTrackingEntry);        
          this.resetNewDOForm(); 
      }
  }
});
</script>

</body>
</html>